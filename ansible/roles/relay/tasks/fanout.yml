---
  - name: install packages required to fanout streams
    apt:
      name:
        - python3-jinja2
      state: latest
      update_cache: yes
    tags: packages

  - name: create directories
    file: dest={{ item }} state=directory
          mode=0755 owner=root group=root
    with_items:
      - /opt/fanout/scripts/
      - "{{ relay_fanout.hls_write_path }}"
      - "{{ relay_fanout.dash_write_path }}"

  - name: copying fanout-scripts
    copy: dest=/opt/fanout/scripts/{{ item }}
          src=fanout/{{ item }}
          owner=root group=root mode=0755
    with_items:
      - audio.py
      - dash.py
      - hls.py
      - webm.py
      - youtube.py
      - fanout_utils.py




  - name: create fanout systemd-units
    template: src=systemd-units/fanout_{{ item }}.service.j2
              dest="/etc/systemd/system/fanout_{{ item }}@.service"
              mode=0644 owner=root group=root
    with_items: ["hls", "dash", "webm", "audio", "thumbnail"]

  - name: create youtube systemd-units
    template: src=systemd-units/fanout_{{ item }}.service.j2
              dest="/etc/systemd/system/fanout_{{ item }}@.service"
              mode=0644 owner=root group=root
    with_items: ["youtube"]
    when: youtube is defined and youtube

  - name: create fanout systemd-target
    template: src=systemd-units/fanout.target.j2
              dest="/etc/systemd/system/fanout@.target"
              mode=0644 owner=root group=root

  - name: reload systemd daemon
    command: systemctl daemon-reload
    changed_when: false

  - name: enable fanout systemd-units
    service: name=fanout_{{ item.0 }}@{{ item.1 }}.service
             enabled=yes
             state=restarted
    with_nested:
      - ["hls", "dash", "webm", "audio", "thumbnail"]
      - "{{ fanout_streams }}"

  - name: enable youtube systemd-units
    service: name=fanout_{{ item.0 }}@{{ item.1 }}.service
             enabled=yes
             state=restarted
    with_nested:
      - ["youtube"]
      - "{{ fanout_streams }}"
    when: youtube is defined and youtube

  - name: enable & start fanout systemd-target
    service: name=fanout@{{ item }}.target
             enabled=yes
    with_items:
      - "{{ fanout_streams }}"
